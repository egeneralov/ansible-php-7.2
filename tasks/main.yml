---

- name: Install base dependencies
  apt:
    update_cache: yes
    cache_valid_time: 360
    name: "{{ item }}"
  with_items:
    - unzip
    - curl
    - gnupg2
    - apt-transport-https
    - libgnutls28-dev
    - zlib1g-dev
    - libevent-dev
    - libicu-dev
    - libidn2-0-dev
    - libidn11-dev
    - librabbitmq-dev
    - libcurl4-gnutls-dev
    - libgnutls28-dev


- apt_key:
    url: https://packages.sury.org/php/apt.gpg
    state: present

- apt_repository:
    repo: deb https://packages.sury.org/php/ stretch main

- apt:
    update_cache: yes
    name: "{{ item }}"
  with_items:
    - php7.2-bcmath
    - php7.2-bz2
    - php7.2-cgi
    - php7.2-cli
    - php7.2-common
    - php7.2-curl
    - php7.2-dba
    - php7.2-dev
    - php7.2-enchant
    - php7.2-fpm
    - php7.2-gd
    - php7.2-gmp
    - php7.2-imap
    - php7.2-interbase
    - php7.2-intl
    - php7.2-json
    - php7.2-ldap
    - php7.2-mbstring
    - php7.2-mysql
    - php7.2-odbc
    - php7.2-opcache
    - php7.2-pgsql
    - php7.2-pspell
    - php7.2-readline
    - php7.2-recode
    - php7.2-snmp
    - php7.2-soap
    - php7.2-sqlite3
    - php7.2-sybase
    - php7.2-tidy
    - php7.2-xml
    - php7.2-xmlrpc
    - php7.2-xsl
    - php7.2-zip

- file:
    path: "/etc/php/7.2/cli/conf.d/20-{{ item }}.ini"
    state: touch
  with_items:
    - amqp
    - raphf
    - propro
    - http
    - amqp

- lineinfile:
    path: "/etc/php/7.2/cli/conf.d/20-{{ item }}.ini"
    line: "extension={{ item }}.so"
    state: present
  with_items:
    - amqp
    - raphf
    - propro
    - http

- name: "composer: get json"
  uri:
    url: "https://getcomposer.org/versions"
    return_content: yes
  register: json_response                                                                                    

- name: "composer: get version"
  debug:
    msg: "Version: {{ ( json_response.content | from_json )['stable'][0]['version'] }}"
  when: ( json_response.content | from_json )['stable'][0]['version'] is defined

- name: "composer: get url"
  debug:
    msg: "URL: https://getcomposer.org{{ ( json_response.content | from_json )['stable'][0]['path'] }}"
  when: ( json_response.content | from_json )['stable'][0]['path'] is defined

- name: "composer: download"
  get_url:
    src: "https://getcomposer.org{{ ( json_response.content | from_json )['stable'][0]['path'] }}"
    dest: /usr/local/sbin/composer

- shell: pecl install amqp
  args:
    creates: "/usr/lib/php/20170718/amqp.so"

- shell: pecl install raphf
  args:
    creates: "/usr/lib/php/20170718/raphf.so"

- shell: pecl install propro
  args:
    creates: "/usr/lib/php/20170718/propro.so"

- shell: pecl install pecl_http
  args:
    creates: "/usr/lib/php/20170718/http.so"
